@model MainOps.Models.ViewModels.ThreeStepTestReport

@{
    var reflevel = Model.test.Ref_Level - Model.test.Water_level;
}

<table style="width:100%">
    <tr>
        @if (Model.test.TestType != null)
        {
            <td><h2>@SharedLocalizer.GetLocalizedHtmlString("Test Report") - @SharedLocalizer.GetLocalizedHtmlString(Model.test.TestType)</h2></td>
        }
        else
        {
            <td><h2>@SharedLocalizer.GetLocalizedHtmlString("Test Report")</h2></td>
        }
        <td colspan="2" align="right"><img src="~/images/Divisions/Photos/@Model.test.Project.DivisionId/@Model.test.Project.Division.LogoPath" width="151" height="66" /></td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Project.Name)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.Project.Name)</td>
        <td></td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.SubProjectId)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.SubProject.Name)</td>
        <td></td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Wellname)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.Wellname)</td>
        <td></td>
    </tr>

    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Report_Date)</b></td>
        <td>
            @Html.DisplayFor(Model => Model.test.Report_Date)
        </td>
        <td></td>
    </tr>

    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.starttime)</b></td>
        <td>
            @Html.DisplayFor(Model => Model.test.starttime)
        </td>
        <td></td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.endtime)</b></td>
        <td>
            @Html.DisplayFor(Model => Model.test.endtime)
        </td>
        <td></td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Water_Meter_Before)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.Water_Meter_Before)</td>
        <td>m3</td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Water_Meter_After)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.Water_Meter_After)</td>
        <td>m3</td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Totalm3)</b></td>
        <td>@string.Format("{0:N2}", Model.test.Totalm3)</td>
        <td>m3</td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Ref_Level)</b></td>
        <td>@string.Format("{0:N2}", Model.test.Ref_Level)</td>
        <td>mDVR90</td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Water_level)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.Water_level)</td>
        <td>m</td>
    </tr>
    <tr>
        <td><b>@SharedLocalizer.GetLocalizedHtmlString("Water level in Reference")</b></td>
        <td>@String.Format("{0:N2} ", reflevel)</td>
        <td>mDVR90</td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Init_Meas_Time)</b></td>
        <td>
            @Html.DisplayFor(Model => Model.test.Init_Meas_Time)
        </td>
        <td></td>
    </tr>
    <tr>
        <td><b>@Html.DisplayNameFor(Model => Model.test.Bottom_well)</b></td>
        <td>@Html.DisplayFor(Model => Model.test.Bottom_well)</td>
        <td>m</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.Q_max_m3_per_hour)</b></td>
        <td>@String.Format("{0:N2} ", Model.Q_max_m3_per_hour)</td>
        <td>m3/h</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.Q_max_m3_per_second)</b></td>
        <td>@String.Format("{0:N3} ", Model.Q_max_m3_per_second)</td>
        <td>m3/s</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.Max_Drawdown)</b></td>
        <td>@String.Format("{0:N2} ", Model.Max_Drawdown)</td>
        <td>mDVR90</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.m_Drawdown_6)</b></td>
        <td>@String.Format("{0:N2} ", Model.m_Drawdown_6)</td>
        <td>mDVR90</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.m_Drawdown_60)</b></td>
        <td>@String.Format("{0:N2} ", Model.m_Drawdown_60)</td>
        <td>mDVR90</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.s_60)</b></td>
        <td>@String.Format("{0:N2} ", Model.s_60)</td>
        <td>m</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.specific_capacity)</b></td>
        <td>@String.Format("{0:N4} ", Model.specific_capacity)</td>
        <td>Q/m</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.delta_s)</b></td>
        <td>@String.Format("{0:N2} ", Model.delta_s)</td>
        <td>m</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.Transmissivity)</b></td>
        <td>@String.Format("{0:N6} ", Model.Transmissivity)</td>
        <td>m/s</td>
    </tr>
    <tr style="border-bottom:double;">
        <td><b>@Html.DisplayNameFor(x => x.Efficiency)</b></td>
        <td>@String.Format("{0:N2} ", Model.Efficiency)</td>
        <td>%</td>
    </tr>
</table>
<h3>@SharedLocalizer.GetLocalizedHtmlString("Test Manual Measurements")</h3>
<table style="width:100%;">
    <thead>
        <tr>
            <th>
                @SharedLocalizer.GetLocalizedHtmlString("Time")
            </th>
            <th>
                @SharedLocalizer.GetLocalizedHtmlString("Flow")
            </th>
            <th>
                @SharedLocalizer.GetLocalizedHtmlString("m3")
            </th>
            <th>
                @SharedLocalizer.GetLocalizedHtmlString("Dip")
            </th>
            <th>
                @SharedLocalizer.GetLocalizedHtmlString("Comment")
            </th>
        </tr>
    </thead>
    <tbody>
        @foreach (var dat in Model.datas_dips)
        {
            <tr>
                <td><input value="@dat.TimeStamp" type="time" disabled="disabled" /></td>
                <td><input value="@dat.Flow" type="number" disabled="disabled" /></td>
                <td><input value="@dat.m3" type="number" disabled="disabled" /></td>
                <td><input value="@dat.Dip" type="number" disabled="disabled" /></td>
                <td><input value="@dat.Comment" type="text" disabled="disabled" /></td>
            </tr>
        }

    </tbody>
</table>_pumptest

<div class="container">
    <div id="chart1"></div>
</div>
@if (User.IsInRole("Admin") || User.IsInRole("Manager"))
{
    <form asp-action="DeleteDataPoint" asp-controller="TrackItems" method="post">
        <button class="btn-hoelscher">
            @SharedLocalizer.GetLocalizedHtmlString("Delete selected point");
        </button>
        <input type="number" hidden="hidden" value="0" name="selectedRow" id="selectedRow" />
        <input type="number" hidden="hidden" value="0" name="selectedCol" id="selectedCol" />
        <input hidden="hidden" id="theid" name="id" value="@Model.test.Id" />
    </form>
}
<br>
<div>
    <form asp-action="StepTestReport_PDF" asp-controller="TrackItems" asp-route-id="@Model.test.Id" method="post" target="_blank" onsubmit="saveimage();">
        <input hidden="hidden" id="imageid" name="theimage" />
        <button class="btn-hoelscher">@SharedLocalizer.GetLocalizedHtmlString("Get PDF")</button>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', { 'packages': ['corechart'] });
        google.load('visualization', '1.0', { 'packages': ['corechart'], 'callback': drawChart });
        var chart;
        var data;
        var option = {
            title: "Time Series Data Graph",
            width: 1000,
            height: 750,
            interpolateNulls: true,
            legend: { position: 'top' },
            vAxes: {
                0: { title: "main"},
                1: { title: "per hour", }
            },
            chartArea: {
                height: '80%', width: '85%', left: 100,
                backgroundColor: { stroke: "gray", strokeWidth: 1 },
            },
            series: calculateSeries(),
            explorer: {
                actions: ['dragToZoom', 'rightClickToReset'],
                axis: 'both',
                keepInBounds: true,
                maxZoomIn: 20.0
            },
            pointSize: 8
        };
        function calculateSeries() {
            var series = {};

            series[0] = {
                type: "line",
                targetAxisIndex: 0
            };
            series[1] = {
                type: "line",
                targetAxisIndex: 0
            };
            series[2] = {
                type: "line",
                targetAxisIndex: 0
            };
            series[3] = {
                type: "line",
                targetAxisIndex: 0
            };
            series[4] = {
                type: "line",
                targetAxisIndex: 0
            };
            series[5] = {
                type: "line",
                targetAxisIndex: 1
            };
            return series;
        }
        function selectHandler() {
            var selectedItem = chart.getSelection()[0];
            if (selectedItem) {
                document.getElementById("selectedCol").value = selectedItem.column;
                document.getElementById("selectedRow").value = selectedItem.row;
            }
        }
        function drawChart()
        {
            chart = new google.visualization.LineChart(document.getElementById('chart1'));
            google.visualization.events.addListener(chart, 'select', selectHandler);
            data = new google.visualization.DataTable();
            data.addColumn('datetime', 'time');
            data.addColumn('number', 'Pump Level');
            data.addColumn('number', 'Moni1 Level');
            data.addColumn('number', 'Moni2 Level');
            data.addColumn('number', 'Moni3 Level');
            data.addColumn('number', 'Moni4 Level');
            data.addColumn('number', 'Flow Rate');
            var theId = $('#theid').val();
            var url = '@Url.Action("JsonDataPumpTest", "TrackItems")';
            $.ajax({
                type: 'GET',
                url: url,
                dataType: 'json',
                data: { 'id': theId },
                success: function (d) {
                    for (var prop in d) {
                        data.addRow
                            ([
                                new Date(d[prop]["timeStamp"]),
                                d[prop]["pumpLevelData"],
                                d[prop]["moni1LevelData"],
                                d[prop]["moni2LevelData"],
                                d[prop]["moni3LevelData"],
                                d[prop]["moni4LevelData"],
                                d[prop]["flowData"]
                            ]);
                    }
                    chart.draw(data, option);
                    saveImage();
                }
            });
        }
        function saveImage() {
            $('#imageid').val(chart.getImageURI());
        }










    </script>
}
